<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đăng nhập / Đăng ký | Travel Booking</title>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://upload.wikimedia.org">
    <link rel="preconnect" href="https://693057bb778bbf9e0070fa8d.mockapi.io">
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    
    <style>
        body {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity .6s ease, transform .6s ease;
            will-change: opacity, transform; 
        }

        body.page-loaded {
            opacity: 1;
            transform: translateY(0);
        }
        
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
            cursor: wait;
        }
        .btn.loading::after {
            content: "";
            position: absolute;
            left: 50%; top: 50%;
            width: 20px; height: 20px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        .input-box {
            position: relative; 
        }
        
        .eye-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #333;
            font-size: 20px;
            z-index: 10;
            transition: color 0.2s;
        }
        .eye-toggle:hover { color: #0d6efd; }
        .input-box input[type="password"], 
        .input-box input[type="text"] {
            padding-right: 45px !important; 
        }
    </style>
</head>
<body>
    <div id="modal-success" class="modal">
        <div class="modal__overlay"></div>
        <div class="modal__content">
            <h2>Đăng ký thành công!</h2>
            <p>Tài khoản của bạn đã được tạo thành công.</p>
            <p class="modal__countdown">
                Tự động chuyển sang đăng nhập sau <span id="modal-count">3</span> giây...
            </p>
            <button id="modal-btn-now" type="button">Đăng nhập ngay</button>
        </div>
    </div>

    <a href="homeba1.html">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Logo_DAI_NAM.png/1128px-Logo_DAI_NAM.png"
            class="logo-dn-page"
            alt="Đại học Đại Nam"
            width="200" 
            height="auto"
            fetchpriority="high">
    </a>

    <div class="container">
        <div class="form-box login">
            <form id="formLogin" autocomplete="off">
                <h1>Đăng nhập</h1>
                <p>Truy cập hệ thống Travel Booking</p>

                <div class="input-box">
                    <input type="email" id="loginEmail" name="email" placeholder="Email" required>
                    <i class='bx bxs-envelope'></i>
                </div>

                <div class="input-box">
                    <input type="password" id="loginPass" name="password" placeholder="Mật khẩu" required>
                    <i class='bx bxs-lock-alt' style="right: 45px;"></i> 
                    <i class='bx bxs-hide eye-toggle' id="toggleLoginPass"></i>
                </div>

                <div id="login-error" class="form-error" style="color: red; margin-bottom: 10px; font-size: 0.9em; min-height: 1.2em;"></div>

                <div class="forgot-link">
                    <a href="#">Quên mật khẩu?</a>
                </div>

                <button type="submit" class="btn">Đăng nhập</button>

                <div class="auth-small-text">
                    <span>Tip:</span> Đăng nhập bằng Email và Mật khẩu đã đăng ký.
                </div>
            </form>
        </div>

        <div class="form-box register">
            <form id="formRegister" autocomplete="off">
                <h1>Đăng ký tài khoản</h1>
                <p>Nhập thông tin cá nhân để tạo tài khoản mới.</p>

                <div class="input-box">
                    <input type="text" id="regName" name="name" placeholder="Họ và tên" required>
                    <i class='bx bxs-user'></i>
                </div>
                
                <div class="input-box">
                    <input type="email" id="regEmail" name="email" placeholder="Email" required>
                    <i class='bx bxs-envelope'></i>
                </div>

                <div class="input-box">
                    <input type="password" id="regPass" name="password" placeholder="Mật khẩu" required>
                    <i class='bx bxs-lock-alt' style="right: 45px;"></i>
                    <i class='bx bxs-hide eye-toggle' id="toggleRegPass"></i>
                </div>
                
                <div id="register-error" class="form-error" style="color: red; margin-bottom: 5px; font-size: 0.9em; min-height: 1.2em;"></div>

                <button type="submit" class="btn">Tạo tài khoản</button>

            </form>
        </div>
        <div class="toggle-box">
            <div class="toggle-panel toggle-left">
                <h1>Xin chào bạn!</h1>
                <p>Nếu chưa có tài khoản, hãy đăng ký mới ngay.</p>
                <button type="button" class="btn register-btn">Đăng ký</button>
            </div>

            <div class="toggle-panel toggle-right">
                <h1>Chào mừng trở lại!</h1>
                <p>Nếu đã có tài khoản, hãy đăng nhập để tiếp tục.</p>
                <button type="button" class="btn login-btn">Đăng nhập</button>
            </div>
        </div>
    </div>

    <script>
        const PROJECT_ID = '693057bb778bbf9e0070fa8d';
        const RESOURCE_NAME = 'user'; 
        const API_URL = `https://${PROJECT_ID}.mockapi.io/api/qldl/${RESOURCE_NAME}`;

        const dom = {
            container: document.querySelector('.container'),
            registerBtn: document.querySelector('.register-btn'),
            loginBtn: document.querySelector('.login-btn'),
            formLogin: document.getElementById('formLogin'),
            formRegister: document.getElementById('formRegister'),
            loginEmail: document.getElementById('loginEmail'),
            loginPass: document.getElementById('loginPass'),
            loginError: document.getElementById('login-error'),
            loginSubmitBtn: document.querySelector('#formLogin .btn'),
            regName: document.getElementById('regName'),
            regEmail: document.getElementById('regEmail'),
            regPass: document.getElementById('regPass'),
            regError: document.getElementById('register-error'),
            regSubmitBtn: document.querySelector('#formRegister .btn'),
            modal: document.getElementById('modal-success'),
            modalCount: document.getElementById('modal-count'),
            modalBtnNow: document.getElementById('modal-btn-now')
        };
        const showError = (el, msg) => {
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => { el.textContent = ''; }, 3000);
        };

        const toggleLoading = (btn, isLoading) => {
            if(isLoading) btn.classList.add('loading');
            else btn.classList.remove('loading');
        };
        function setupPasswordToggle(toggleId, inputId) {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);
            if (toggle && input) {
                toggle.addEventListener('click', () => {
                    const isPassword = input.getAttribute('type') === 'password';
                    input.setAttribute('type', isPassword ? 'text' : 'password');
                    toggle.classList.toggle('bxs-hide');
                    toggle.classList.toggle('bxs-show');
                });
            }
        }
        setupPasswordToggle('toggleLoginPass', 'loginPass');
        setupPasswordToggle('toggleRegPass', 'regPass');
        dom.registerBtn.addEventListener('click', () => {
            dom.container.classList.add('active');
            dom.formRegister.reset();
            dom.regError.textContent = '';
        });

        dom.loginBtn.addEventListener('click', () => {
            dom.container.classList.remove('active');
            dom.formLogin.reset();
            dom.loginError.textContent = '';
        });

        document.addEventListener("DOMContentLoaded", () => {
            requestAnimationFrame(() => {
                document.body.classList.add("page-loaded");
            });
        });
        dom.formRegister.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            toggleLoading(dom.regSubmitBtn, true);

            const name = dom.regName.value.trim();
            const email = dom.regEmail.value.trim().toLowerCase();
            const password = dom.regPass.value.trim();

            try {
                const checkRes = await fetch(`${API_URL}?email=${email}`);
                let existingUsers = [];
                
                if (checkRes.ok) {
                    existingUsers = await checkRes.json();
                } else if (checkRes.status !== 404) {
                    throw new Error('Lỗi kết nối kiểm tra email');
                }
                
                if (Array.isArray(existingUsers) && existingUsers.length > 0) {
                    showError(dom.regError, 'Email này đã được sử dụng!');
                    toggleLoading(dom.regSubmitBtn, false);
                    return;
                }
                const createRes = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name, email, password,
                        createdAt: new Date().toISOString()
                    })
                });

                if (createRes.ok) {
                    showSuccessModal();
                } else {
                    throw new Error('Lỗi khi tạo tài khoản');
                }

            } catch (error) {
                console.error(error);
                showError(dom.regError, error.message || 'Có lỗi xảy ra');
            } finally {
                toggleLoading(dom.regSubmitBtn, false);
            }
        });
        dom.formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoading(dom.loginSubmitBtn, true);

            const email = dom.loginEmail.value.trim().toLowerCase();
            const password = dom.loginPass.value.trim();

            try {
                const response = await fetch(`${API_URL}?email=${email}&password=${password}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError(dom.loginError, 'Email hoặc mật khẩu không chính xác.');
                        return;
                    }
                    throw new Error('Lỗi kết nối API');
                }

                const users = await response.json();

                if (Array.isArray(users) && users.length > 0) {
                    localStorage.setItem('currentUser', JSON.stringify(users[0]));
                    window.location.href = 'home.html'; 
                } else {
                    showError(dom.loginError, 'Email hoặc mật khẩu không chính xác.');
                }

            } catch (error) {
                console.error(error);
                showError(dom.loginError, 'Lỗi kết nối Server.');
            } finally {
                toggleLoading(dom.loginSubmitBtn, false);
            }
        });

        function showSuccessModal() {
            dom.modal.classList.add('modal--show');
            let counter = 3;
            dom.modalCount.textContent = counter;

            const switchToLogin = () => {
                dom.modal.classList.remove('modal--show');
                dom.container.classList.remove('active'); 
                dom.formRegister.reset();
            };

            const timer = setInterval(() => {
                counter--;
                dom.modalCount.textContent = counter;
                if (counter <= 0) {
                    clearInterval(timer);
                    switchToLogin();
                }
            }, 1000);

            dom.modalBtnNow.onclick = () => {
                clearInterval(timer);
                switchToLogin();
            };
        }
    </script>
</body>
</html>